<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DroidGen Final</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-vsc-dark-plus.min.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-css.min.js"></script>
    
    <style>
        /* PRO THEME SETUP */
        :root { --bg: #09090b; --panel: #18181b; --border: #27272a; --accent: #3b82f6; }
        body { background-color: var(--bg); color: #e4e4e7; font-family: 'Geist Mono', 'Menlo', monospace; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        /* SCROLLBARS */
        ::-webkit-scrollbar { width: 5px; height: 5px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #3f3f46; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #52525b; }

        /* EDITOR TABS */
        .tab { @apply px-4 py-2 text-xs border-r border-[#27272a] cursor-pointer text-zinc-500 hover:text-zinc-300 hover:bg-[#27272a]/50 transition-colors; }
        .tab.active { @apply text-blue-400 bg-[#18181b] border-t-2 border-t-blue-500; }
        
        /* UTILS */
        .glass-panel { background: rgba(24, 24, 27, 0.8); backdrop-filter: blur(12px); border-bottom: 1px solid var(--border); }
        code { font-family: 'Menlo', 'Consolas', monospace !important; font-size: 13px; line-height: 1.6; }
        iframe { background: white; width: 100%; height: 100%; border: none; }
    </style>
</head>
<body>

    <div class="h-14 glass-panel flex items-center px-5 gap-4 shrink-0 z-10">
        <div class="font-bold tracking-tighter text-xl bg-gradient-to-r from-blue-400 to-cyan-400 bg-clip-text text-transparent">DROIDGEN</div>
        
        <div class="h-6 w-px bg-zinc-800"></div>

        <div class="flex items-center gap-3">
            <select id="modelSelect" class="bg-[#27272a] text-zinc-300 text-xs rounded-md px-3 py-1.5 border border-zinc-700 focus:border-blue-500 outline-none appearance-none cursor-pointer hover:bg-zinc-700 transition-colors">
                <option value="liquid/lfm-2.5">LFM 2.5</option>
                <option value="z-ai/glm-4.5-air:free">GLM 4.5 Air</option>
                <option value="moonshotai/kimi-k2:free">Kimi K2</option>
                <option value="google/gemma-3-27b-it:free">Gemma 3</option>
            </select>

            <div id="thinkToggle" class="hidden flex items-center gap-2 px-2 py-1 rounded bg-[#27272a]/50 border border-zinc-800 cursor-pointer select-none group">
                <div id="thinkDot" class="w-2 h-2 rounded-full bg-zinc-600 group-hover:bg-zinc-500 transition-colors"></div>
                <span class="text-[10px] uppercase font-bold text-zinc-500 group-hover:text-zinc-300">Think</span>
            </div>
        </div>

        <div class="flex-1 max-w-2xl relative">
            <input id="promptInput" type="text" placeholder="Describe your app or changes..." 
                class="w-full bg-[#18181b] border border-zinc-700 text-sm text-white rounded-md pl-4 pr-12 py-2 focus:ring-1 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all placeholder:text-zinc-600">
            <div class="absolute right-2 top-2 text-[10px] text-zinc-600 border border-zinc-800 rounded px-1.5 py-0.5">‚èé</div>
        </div>

        <button id="runBtn" onclick="run()" class="ml-auto bg-blue-600 hover:bg-blue-500 text-white text-xs font-bold px-5 py-2 rounded-md flex items-center gap-2 transition-all shadow-[0_0_15px_-3px_rgba(59,130,246,0.5)]">
            <span id="btnText">GENERATE</span>
            <svg id="loader" class="hidden w-3 h-3 animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path></svg>
        </button>
    </div>

    <div class="flex flex-1 overflow-hidden">
        
        <div class="w-1/2 flex flex-col border-r border-[#27272a] bg-[#1e1e1e]">
            <div id="tabContainer" class="flex bg-[#18181b] border-b border-[#27272a] h-10 overflow-x-auto scrollbar-hide">
                </div>

            <div class="flex-1 relative overflow-hidden group">
                <pre class="h-full overflow-auto m-0 !bg-[#1e1e1e] !p-4"><code id="codeDisplay" class="!bg-transparent outline-none" spellcheck="false"></code></pre>
                
                <div id="streamStatus" class="hidden absolute top-4 right-4 text-[10px] font-mono text-green-400 bg-green-400/10 px-2 py-1 rounded border border-green-400/20 animate-pulse">
                    ‚óè RECEIVING DATA
                </div>
            </div>
            
            <div id="statusLog" class="h-8 bg-[#18181b] border-t border-[#27272a] text-xs flex items-center px-4 text-zinc-500 font-mono">
                System Ready.
            </div>
        </div>

        <div class="w-1/2 flex flex-col relative bg-zinc-100">
            <iframe id="previewFrame" sandbox="allow-scripts allow-modals allow-same-origin"></iframe>
            
            <div class="absolute bottom-4 right-4 flex gap-2">
                <button onclick="updatePreview()" class="bg-black/80 hover:bg-black text-white p-2 rounded-full backdrop-blur-md shadow-lg border border-white/10 transition-transform hover:scale-105 active:scale-95" title="Reload Preview">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M23 4v6h-6"/><path d="M1 20v-6h6"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>
                </button>
            </div>
        </div>
    </div>

    <script>
        // --- CORE STATE ---
        // The single source of truth for the project
        let files = {
            'index.html': '',
            'style.css': '/* CSS styles */',
            'script.js': '// JavaScript logic'
        };
        let activeFile = 'index.html';
        let isThinking = false;

        // --- DOM REFERENCES ---
        const dom = {
            input: document.getElementById('promptInput'),
            btn: document.getElementById('runBtn'),
            btnText: document.getElementById('btnText'),
            loader: document.getElementById('loader'),
            code: document.getElementById('codeDisplay'),
            tabs: document.getElementById('tabContainer'),
            preview: document.getElementById('previewFrame'),
            status: document.getElementById('statusLog'),
            model: document.getElementById('modelSelect'),
            thinkToggle: document.getElementById('thinkToggle'),
            thinkDot: document.getElementById('thinkDot'),
            streamStatus: document.getElementById('streamStatus')
        };

        // --- UI RENDERERS ---
        function renderTabs() {
            dom.tabs.innerHTML = Object.keys(files).map(name => {
                const ext = name.split('.').pop();
                const icon = ext === 'html' ? 'üåê' : ext === 'css' ? 'üé®' : '‚ö°';
                return `
                <div onclick="switchTab('${name}')" 
                     class="tab flex items-center gap-2 ${name === activeFile ? 'active' : ''}">
                    <span class="opacity-70">${icon}</span> ${name}
                </div>
            `}).join('');
            
            // Render Code
            dom.code.textContent = files[activeFile] || "";
            // Syntax Highlight (Prism)
            const langMap = { 'html': 'html', 'css': 'css', 'js': 'javascript' };
            const ext = activeFile.split('.').pop();
            dom.code.className = `language-${langMap[ext] || 'javascript'}`;
            Prism.highlightElement(dom.code);
        }

        function switchTab(name) {
            activeFile = name;
            renderTabs();
        }

        function setStatus(msg, type = 'neutral') {
            dom.status.textContent = `> ${msg}`;
            dom.status.className = `h-8 bg-[#18181b] border-t border-[#27272a] text-xs flex items-center px-4 font-mono ${
                type === 'error' ? 'text-red-400' : type === 'success' ? 'text-green-400' : 'text-zinc-500'
            }`;
        }

        // --- MODEL & THINKING LOGIC ---
        dom.model.addEventListener('change', () => {
            const isLiquid = dom.model.value.includes('liquid');
            dom.thinkToggle.classList.toggle('hidden', !isLiquid);
        });
        // Initial Check
        dom.model.dispatchEvent(new Event('change'));

        dom.thinkToggle.addEventListener('click', () => {
            isThinking = !isThinking;
            dom.thinkDot.className = `w-2 h-2 rounded-full transition-colors ${isThinking ? 'bg-blue-500 shadow-[0_0_8px_rgba(59,130,246,0.8)]' : 'bg-zinc-600'}`;
        });

        // --- THE ENGINE (Robust Parser) ---
        async function run() {
            const prompt = dom.input.value.trim();
            if (!prompt) return;

            // 1. LOCK UI
            dom.input.disabled = true;
            dom.btn.disabled = true;
            dom.btnText.textContent = "BUILDING";
            dom.loader.classList.remove('hidden');
            dom.streamStatus.classList.remove('hidden');
            setStatus("Initializing connection...", "neutral");

            // 2. MODEL CONFIG
            let modelId = dom.model.value;
            if (modelId.includes('liquid')) {
                modelId = isThinking ? 'liquid/lfm-2.5-1.2b-thinking:free' : 'liquid/lfm-2.5-1.2b-instruct:free';
            }

            // 3. CONTEXT BUILDER (Sends current files to AI)
            const fileContext = Object.entries(files).map(([name, content]) => 
                `FILENAME: ${name}\n\`\`\`\n${content}\n\`\`\``
            ).join('\n\n');

            const systemPrompt = `You are DroidGen, an expert web developer.
            
            CURRENT FILES:
            ${fileContext}
            
            USER REQUEST: "${prompt}"

            INSTRUCTIONS:
            1. Output the FULL content of any file you change.
            2. Use this EXACT format:
            <<<FILE:filename.ext>>>
            ...content...
            <<<END>>>
            3. Do not use markdown code blocks (\`\`\`). Just raw text inside the markers.
            4. If editing css/js, ensure index.html links to them.
            `;

            try {
                const res = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        model: modelId,
                        messages: [{ role: 'system', content: systemPrompt }]
                    })
                });

                if (!res.ok) throw new Error(`API Error: ${res.status}`);

                // 4. STREAMING & PARSING
                const reader = res.body.getReader();
                const decoder = new TextDecoder();
                
                let buffer = ""; 
                let currentFile = null;

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n');

                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const data = line.replace('data: ', '').trim();
                            if (data === '[DONE]') break;
                            try {
                                const json = JSON.parse(data);
                                const content = json.choices[0]?.delta?.content || "";
                                
                                buffer += content;

                                // --- PARSING STATE MACHINE ---
                                while (true) {
                                    // CASE A: Searching for a file start
                                    if (!currentFile) {
                                        const startMatch = buffer.match(/<<<FILE:(.*?)>>>/);
                                        if (startMatch) {
                                            const filename = startMatch[1].trim();
                                            currentFile = filename;
                                            files[currentFile] = ""; // Reset file content
                                            
                                            // Auto-switch tab to what's being written
                                            activeFile = currentFile;
                                            renderTabs();
                                            setStatus(`Writing ${currentFile}...`, "success");

                                            // Remove tag from buffer and continue processing
                                            buffer = buffer.substring(startMatch.index + startMatch[0].length);
                                            continue; 
                                        }
                                    }

                                    // CASE B: Inside a file, searching for end
                                    if (currentFile) {
                                        const endIdx = buffer.indexOf("<<<END>>>");
                                        
                                        if (endIdx !== -1) {
                                            // Found END tag. Write pre-tag content.
                                            const safeContent = buffer.substring(0, endIdx);
                                            files[currentFile] += safeContent;
                                            
                                            // Update UI
                                            if (activeFile === currentFile) {
                                                dom.code.textContent = files[currentFile];
                                                dom.code.parentElement.scrollTop = dom.code.parentElement.scrollHeight;
                                            }

                                            // Close file
                                            currentFile = null;
                                            buffer = buffer.substring(endIdx + 9); // Remove <<<END>>>
                                            continue;
                                        } else {
                                            // No END tag yet.
                                            // SAFETY: Keep last 10 chars in buffer to prevent splitting <<<END>>>
                                            if (buffer.length > 10) {
                                                const safeChunk = buffer.substring(0, buffer.length - 10);
                                                files[currentFile] += safeChunk;
                                                buffer = buffer.substring(buffer.length - 10);
                                                
                                                // Live Update
                                                if (activeFile === currentFile) {
                                                    dom.code.textContent = files[currentFile];
                                                    dom.code.parentElement.scrollTop = dom.code.parentElement.scrollHeight;
                                                }
                                            }
                                        }
                                    }
                                    break; // Need more data
                                }

                            } catch (e) { /* ignore json errors */ }
                        }
                    }
                }

                setStatus("Generation Complete", "success");
                updatePreview();

            } catch (err) {
                console.error(err);
                setStatus(`Error: ${err.message}`, "error");
            } finally {
                dom.input.disabled = false;
                dom.input.value = '';
                dom.btn.disabled = false;
                dom.btnText.textContent = "GENERATE";
                dom.loader.classList.add('hidden');
                dom.streamStatus.classList.add('hidden');
            }
        }

        // --- PREVIEW LOGIC ---
        function updatePreview() {
            let html = files['index.html'] || "";
            const css = files['style.css'] || "";
            const js = files['script.js'] || "";

            // Inject Dependencies
            if (css) html = html.replace('</head>', `<style>${css}</style></head>`);
            if (js) html = html.replace('</body>', `<script>${js}<\/script></body>`);

            dom.preview.srcdoc = html;
        }

        // Initial Setup
        renderTabs();
        dom.input.addEventListener('keydown', (e) => { if (e.key === 'Enter') run(); });

    </script>
</body>
</html>
