<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DroidGen.Beta</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #0a0a0a; color: white; font-family: monospace; overflow: hidden; height: 100vh; display: flex; flex-direction: column; }
        iframe { width: 100%; height: 100%; border: none; background: white; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
    </style>
</head>
<body>

    <div class="h-16 border-b border-neutral-800 bg-neutral-900 flex items-center px-4 gap-4">
        <div class="text-blue-500 font-bold text-lg">DroidGen.Beta</div>
        
        <select id="modelSelect" class="bg-neutral-800 border border-neutral-700 rounded px-2 py-1 text-sm outline-none">
            <option value="liquid/lfm-2.5">LFM 2.5 (Select Mode ->)</option>
            <option value="z-ai/glm-4.5-air:free">GLM 4.5 Air</option>
            <option value="moonshotai/kimi-k2:free">Kimi K2</option>
            <option value="google/gemma-3-27b-it:free">Gemma 3</option>
            <option value="z-ai/glm-4.7-flash">GLM 4.7 Flash</option>
        </select>

        <div id="thinkingToggle" class="hidden flex items-center gap-2 bg-neutral-800 px-2 py-1 rounded border border-neutral-700 select-none cursor-pointer">
            <span class="text-xs text-neutral-400 font-bold">THINKING</span>
            <div class="w-8 h-4 bg-neutral-600 rounded-full relative transition-colors" id="toggleBg">
                <div class="absolute top-0.5 left-0.5 w-3 h-3 bg-white rounded-full transition-all" id="toggleDot"></div>
            </div>
        </div>

        <input id="promptInput" type="text" placeholder="Make a button that bounces..." class="flex-1 bg-black border border-neutral-700 rounded px-3 py-1 outline-none focus:border-blue-500">
        
        <button onclick="generate()" id="runBtn" class="bg-blue-600 hover:bg-blue-700 px-4 py-1 rounded text-white font-bold">RUN</button>
    </div>

    <div class="flex flex-1 overflow-hidden">
        <div class="w-64 bg-neutral-900 border-r border-neutral-800 flex flex-col">
            <div class="p-2 text-xs text-neutral-500 font-bold">REVISIONS</div>
            <div id="revisionList" class="flex-1 overflow-y-auto p-2 space-y-2 scrollbar-hide"></div>
            <div class="p-2 border-t border-neutral-800">
                <button onclick="clearAll()" class="w-full text-xs text-red-500 hover:text-red-400">Clear All Data</button>
            </div>
        </div>

        <div class="flex-1 relative bg-white">
            <iframe id="previewFrame"></iframe>
            <div id="verLabel" class="absolute bottom-4 right-4 bg-black/80 text-white text-xs px-2 py-1 rounded backdrop-blur border border-white/10 pointer-events-none">
                Waiting...
            </div>
        </div>
    </div>

    <script>
        // --- CONFIG & STATE ---
        let revisions = JSON.parse(localStorage.getItem('droidgen_revs') || '[]');
        let currentRevId = revisions.length > 0 ? revisions[0].id : null;
        let isThinking = false;

        const dom = {
            input: document.getElementById('promptInput'),
            model: document.getElementById('modelSelect'),
            toggle: document.getElementById('thinkingToggle'),
            toggleBg: document.getElementById('toggleBg'),
            toggleDot: document.getElementById('toggleDot'),
            list: document.getElementById('revisionList'),
            frame: document.getElementById('previewFrame'),
            ver: document.getElementById('verLabel'),
            btn: document.getElementById('runBtn')
        };

        // --- UI HANDLERS ---
        function renderRevisions() {
            dom.list.innerHTML = '';
            revisions.forEach((rev, idx) => {
                const el = document.createElement('div');
                const isSelected = rev.id === currentRevId;
                el.className = `p-2 rounded border cursor-pointer text-xs ${isSelected ? 'bg-neutral-800 border-blue-500' : 'bg-black border-neutral-800 hover:border-neutral-600'}`;
                el.innerHTML = `
                    <div class="flex justify-between mb-1">
                        <span class="font-bold text-blue-400">${rev.modelShort}</span>
                        ${rev.pinned ? 'ðŸ“Œ' : ''}
                    </div>
                    <div class="text-neutral-300 truncate">${rev.prompt}</div>
                    <div class="flex justify-end gap-2 mt-2 ${isSelected ? 'opacity-100' : 'opacity-0 group-hover:opacity-100'}">
                        <span onclick="togglePin('${rev.id}', event)" class="hover:text-yellow-400">Pin</span>
                        <span onclick="delRev('${rev.id}', event)" class="hover:text-red-400">Del</span>
                    </div>
                `;
                el.onclick = () => loadRev(rev.id);
                dom.list.appendChild(el);
            });
            updateFrame();
        }

        function updateFrame() {
            const rev = revisions.find(r => r.id === currentRevId);
            if (rev) {
                dom.frame.srcdoc = rev.code;
                dom.ver.innerText = `Ver: ${rev.id.slice(-4)} | ${rev.modelShort}`;
            } else {
                dom.frame.srcdoc = "<html><body style='display:grid;place-items:center;height:100vh;font-family:sans-serif;'><h2>DroidGen.Beta Ready</h2></body></html>";
                dom.ver.innerText = "New Project";
            }
        }

        function loadRev(id) {
            currentRevId = id;
            renderRevisions();
        }

        // --- LOGIC ---
        dom.model.addEventListener('change', () => {
            if (dom.model.value.includes('liquid')) {
                dom.toggle.classList.remove('hidden');
                dom.toggle.classList.add('flex');
            } else {
                dom.toggle.classList.add('hidden');
                dom.toggle.classList.remove('flex');
            }
        });

        dom.toggle.addEventListener('click', () => {
            isThinking = !isThinking;
            dom.toggleBg.className = `w-8 h-4 rounded-full relative transition-colors ${isThinking ? 'bg-blue-600' : 'bg-neutral-600'}`;
            dom.toggleDot.className = `absolute top-0.5 w-3 h-3 bg-white rounded-full transition-all ${isThinking ? 'left-4.5 translate-x-full' : 'left-0.5'}`;
            // Adjust left via inline style for precision or just toggle class
            dom.toggleDot.style.left = isThinking ? '18px' : '2px';
        });

        async function generate() {
            const prompt = dom.input.value;
            if (!prompt) return;

            dom.btn.innerText = "Processing...";
            dom.btn.disabled = true;

            // Get Context
            const currentCode = revisions.find(r => r.id === currentRevId)?.code || "";
            
            // Resolve Model ID
            let modelId = dom.model.value;
            if (modelId.includes('liquid')) {
                modelId = isThinking ? 'liquid/lfm-2.5-1.2b-thinking:free' : 'liquid/lfm-2.5-1.2b-instruct:free';
            }

            const system = `You are DroidGen, a single-file web generator. 
            User Input: "${prompt}"
            CURRENT HTML (if any):
            ${currentCode}
            
            RETURN ONLY VALID HTML. INCLUDE CSS/JS INSIDE THE HTML. NO MARKDOWN. NO \`\`\`.`;

            try {
                const res = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        model: modelId,
                        messages: [{ role: "system", content: system }, { role: "user", content: prompt }]
                    })
                });
                
                const data = await res.json();
                let code = data.choices?.[0]?.message?.content || "";
                
                // Cleanup
                code = code.replace(/```html/g, '').replace(/```/g, '');

                const newRev = {
                    id: Date.now().toString(),
                    prompt: prompt,
                    code: code,
                    modelShort: modelId.split('/')[1].split(':')[0],
                    pinned: false
                };

                revisions.unshift(newRev); // Add to top
                currentRevId = newRev.id;
                save();
                renderRevisions();
                dom.input.value = '';

            } catch (e) {
                alert("Error: " + e.message);
            }

            dom.btn.innerText = "RUN";
            dom.btn.disabled = false;
        }

        // --- UTILS ---
        function togglePin(id, e) {
            e.stopPropagation();
            const rev = revisions.find(r => r.id === id);
            if (rev) { rev.pinned = !rev.pinned; save(); renderRevisions(); }
        }

        function delRev(id, e) {
            e.stopPropagation();
            revisions = revisions.filter(r => r.id !== id);
            if (currentRevId === id) currentRevId = revisions[0]?.id || null;
            save(); renderRevisions();
        }

        function save() {
            localStorage.setItem('droidgen_revs', JSON.stringify(revisions));
        }

        function clearAll() {
            if(confirm("Delete all history?")) {
                localStorage.removeItem('droidgen_revs');
                revisions = [];
                currentRevId = null;
                renderRevisions();
            }
        }

        // Init
        dom.model.dispatchEvent(new Event('change'));
        renderRevisions();

        // Enter key support
        dom.input.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') generate();
        })

    </script>
</body>
</html>
