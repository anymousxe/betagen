<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DroidGen Beta v3.1</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-css.min.js"></script>
    
    <style>
        body { background-color: #0d0d0d; color: #e5e5e5; font-family: 'Menlo', 'Consolas', monospace; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #1e1e1e; }
        ::-webkit-scrollbar-thumb { background: #444; border-radius: 3px; }
        .tab.active { background-color: #1e1e1e; color: #fff; border-top: 2px solid #3b82f6; }
        .tab { background-color: #2d2d2d; color: #888; }
        iframe { background: white; width: 100%; height: 100%; border: none; }
    </style>
</head>
<body>

    <div class="h-14 bg-[#111] border-b border-[#333] flex items-center px-4 gap-3 shrink-0">
        <div class="font-bold text-blue-500 tracking-tighter text-lg">DROIDGEN<span class="text-xs align-top opacity-50">v3.1</span></div>
        
        <select id="modelSelect" class="bg-[#222] border border-[#333] text-xs rounded px-2 py-2 outline-none hover:border-blue-500 transition-colors">
            <option value="liquid/lfm-2.5">LFM 2.5 (Select Mode)</option>
            <option value="z-ai/glm-4.5-air:free">GLM 4.5 Air</option>
            <option value="moonshotai/kimi-k2:free">Kimi K2</option>
            <option value="google/gemma-3-27b-it:free">Gemma 3</option>
        </select>

        <div id="thinkingContainer" class="hidden flex items-center gap-2 bg-[#1a1a1a] px-3 py-1.5 rounded border border-[#333] cursor-pointer select-none">
            <span class="text-[10px] uppercase font-bold text-gray-400">Thinking</span>
            <div id="thinkToggle" class="w-8 h-4 bg-gray-600 rounded-full relative transition-colors">
                <div id="thinkDot" class="absolute top-0.5 left-0.5 w-3 h-3 bg-white rounded-full transition-all"></div>
            </div>
        </div>

        <div class="flex-1 relative group">
            <input id="promptInput" type="text" placeholder="Type instructions to create or edit..." 
                class="w-full bg-black border border-[#333] rounded px-4 py-2 text-sm focus:border-blue-500 focus:ring-1 focus:ring-blue-500 outline-none transition-all">
        </div>
        
        <button id="runBtn" onclick="run()" class="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2 rounded text-sm font-bold flex items-center gap-2 transition-colors">
            <span>RUN</span>
            <div id="loader" class="hidden w-3 h-3 border-2 border-white/50 border-t-white rounded-full animate-spin"></div>
        </button>
    </div>

    <div class="flex flex-1 overflow-hidden">
        
        <div class="w-1/2 flex flex-col border-r border-[#333] bg-[#1e1e1e]">
            <div id="tabContainer" class="flex bg-[#252526] overflow-x-auto border-b border-[#333] h-9"></div>

            <div class="flex-1 relative overflow-auto group">
                <pre><code id="codeDisplay" class="language-javascript text-sm leading-relaxed block p-4 outline-none" spellcheck="false"></code></pre>
                <div id="streamingIndicator" class="hidden absolute top-4 right-4 text-xs text-green-400 font-mono animate-pulse">‚óè Receiving Code...</div>
            </div>
            
            <div id="statusLog" class="h-8 bg-[#222] border-t border-[#333] text-xs flex items-center px-4 text-gray-500 truncate">
                Ready.
            </div>
        </div>

        <div class="w-1/2 flex flex-col relative bg-white">
            <iframe id="previewFrame" sandbox="allow-scripts allow-modals allow-same-origin"></iframe>
            <button onclick="updatePreview()" class="absolute bottom-4 right-4 bg-black/80 text-white p-2 rounded-full hover:bg-black transition-colors" title="Force Refresh">
               Refresh
            </button>
        </div>
    </div>

    <script>
        // --- STATE ---
        let files = {
            'index.html': '',
            'style.css': '/* Styles */',
            'script.js': '// Logic'
        };
        let activeFile = 'index.html';
        let isThinking = false;

        // --- DOM ---
        const dom = {
            input: document.getElementById('promptInput'),
            btn: document.getElementById('runBtn'),
            loader: document.getElementById('loader'),
            code: document.getElementById('codeDisplay'),
            tabs: document.getElementById('tabContainer'),
            preview: document.getElementById('previewFrame'),
            status: document.getElementById('statusLog'),
            model: document.getElementById('modelSelect'),
            thinkBox: document.getElementById('thinkingContainer'),
            thinkToggle: document.getElementById('thinkToggle'),
            thinkDot: document.getElementById('thinkDot'),
            streamInd: document.getElementById('streamingIndicator')
        };

        // --- UI RENDERERS ---
        function renderTabs() {
            dom.tabs.innerHTML = Object.keys(files).map(name => `
                <div onclick="switchTab('${name}')" 
                     class="tab px-4 py-2 text-xs cursor-pointer flex items-center gap-2 border-r border-[#1e1e1e] ${name === activeFile ? 'active' : ''}">
                    ${name}
                </div>
            `).join('');
            
            // Display content
            dom.code.textContent = files[activeFile] || "";
            // Syntax Highlight
            const ext = activeFile.split('.')[1];
            dom.code.className = `language-${ext === 'js' ? 'javascript' : ext}`;
            Prism.highlightElement(dom.code);
        }

        function switchTab(name) {
            activeFile = name;
            renderTabs();
        }

        // --- TOGGLES ---
        dom.model.addEventListener('change', () => {
            const showThink = dom.model.value.includes('liquid');
            dom.thinkBox.style.display = showThink ? 'flex' : 'none';
        });
        dom.model.dispatchEvent(new Event('change'));

        dom.thinkBox.addEventListener('click', () => {
            isThinking = !isThinking;
            dom.thinkToggle.className = `w-8 h-4 rounded-full relative transition-colors ${isThinking ? 'bg-blue-600' : 'bg-gray-600'}`;
            dom.thinkDot.className = `absolute top-0.5 w-3 h-3 bg-white rounded-full transition-all ${isThinking ? 'left-4.5' : 'left-0.5'}`;
        });

        // --- CORE ENGINE ---
        async function run() {
            const prompt = dom.input.value.trim();
            if (!prompt) return;

            // 1. UI LOCK
            dom.btn.disabled = true;
            dom.loader.classList.remove('hidden');
            dom.streamInd.classList.remove('hidden');
            dom.status.innerText = "Connecting to API...";
            dom.status.className = "h-8 bg-[#222] border-t border-[#333] text-xs flex items-center px-4 text-blue-400";

            // 2. PREPARE MODEL
            let model = dom.model.value;
            if(model.includes('liquid')) {
                model = isThinking ? 'liquid/lfm-2.5-1.2b-thinking:free' : 'liquid/lfm-2.5-1.2b-instruct:free';
            }

            // 3. BUILD CONTEXT (Contextual Edit Memory)
            const fileContext = Object.entries(files).map(([name, content]) => 
                `FILENAME: ${name}\n\`\`\`\n${content}\n\`\`\``
            ).join('\n\n');

            const systemPrompt = `You are a Live Coding Engine.
            
            CURRENT FILES:
            ${fileContext}
            
            USER REQUEST: "${prompt}"

            RULES:
            1. Output the FULL content of any file you edit.
            2. Use this EXACT format:
            <<<FILE:filename.ext>>>
            ...content...
            <<<END>>>
            3. Do not output markdown code blocks (like \`\`\`). Just the raw code inside the markers.
            4. Always check if index.html needs updating to link new css/js.
            `;

            try {
                // 4. API CALL
                const res = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        model: model,
                        messages: [{ role: 'system', content: systemPrompt }] 
                    })
                });

                if(!res.ok) throw new Error("API Failed: " + res.statusText);

                // 5. STREAM PARSING
                const reader = res.body.getReader();
                const decoder = new TextDecoder();
                
                let buffer = ""; // Raw text buffer
                let currentFile = null;

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    const chunk = decoder.decode(value);
                    
                    // Parse SSE (Server Sent Events)
                    const lines = chunk.split('\n');
                    
                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const data = line.replace('data: ', '').trim();
                            if (data === '[DONE]') break;
                            
                            try {
                                const json = JSON.parse(data);
                                const content = json.choices[0]?.delta?.content || "";
                                
                                // --- STREAM PROCESSOR ---
                                // Simple state machine to detect file markers
                                buffer += content;

                                // Check for Start Marker
                                const startMatch = buffer.match(/<<<FILE:(.*?)>>>/);
                                if (startMatch) {
                                    // We found a start marker!
                                    const filename = startMatch[1].trim();
                                    
                                    // 1. Finalize previous file if any (safety check)
                                    // 2. Set new active file
                                    currentFile = filename;
                                    files[currentFile] = ""; // Reset content to empty start
                                    activeFile = currentFile; // Switch UI tab
                                    renderTabs(); // Update UI
                                    
                                    // Remove the marker from buffer so we don't process it as code
                                    buffer = buffer.replace(startMatch[0], ""); 
                                }

                                // Check for End Marker
                                const endMatch = buffer.match(/<<<END>>>/);
                                if (endMatch) {
                                    // We found an end marker!
                                    // Everything before the marker is code
                                    const codePart = buffer.substring(0, endMatch.index);
                                    
                                    if (currentFile) {
                                        files[currentFile] += codePart;
                                        // Update the specific code view if we are looking at it
                                        if (activeFile === currentFile) {
                                            dom.code.textContent = files[currentFile];
                                            dom.code.parentElement.scrollTop = dom.code.parentElement.scrollHeight;
                                        }
                                    }
                                    
                                    // Reset
                                    buffer = buffer.substring(endMatch.index + 7); // Remove <<<END>>>
                                    currentFile = null;
                                } else if (currentFile) {
                                    // We are INSIDE a file and haven't seen END yet.
                                    // Flush buffer to file content safely
                                    // We keep a small tail in buffer in case it's part of <<<END>>> tag
                                    if (buffer.length > 20) {
                                        const safeChunk = buffer.substring(0, buffer.length - 10);
                                        files[currentFile] += safeChunk;
                                        buffer = buffer.substring(buffer.length - 10);
                                        
                                        if (activeFile === currentFile) {
                                            dom.code.textContent = files[currentFile] + buffer; // preview what we have
                                            dom.code.parentElement.scrollTop = dom.code.parentElement.scrollHeight;
                                        }
                                    }
                                }

                            } catch (e) { /* ignore JSON parse errors */ }
                        }
                    }
                }
                
                // Final flush of any remaining buffer
                if (currentFile && buffer.trim()) {
                     files[currentFile] += buffer.replace('<<<END>>>', '');
                     dom.code.textContent = files[currentFile];
                }

                dom.status.innerText = "Generation complete.";
                dom.status.className = "h-8 bg-[#222] border-t border-[#333] text-xs flex items-center px-4 text-green-500";
                
                // Update final preview
                updatePreview();

            } catch (err) {
                console.error(err);
                dom.status.innerText = "Error: " + err.message;
                dom.status.className = "h-8 bg-[#222] border-t border-[#333] text-xs flex items-center px-4 text-red-500";
            } finally {
                dom.btn.disabled = false;
                dom.loader.classList.add('hidden');
                dom.streamInd.classList.add('hidden');
            }
        }

        function updatePreview() {
            let html = files['index.html'] || "";
            const css = files['style.css'] || "";
            const js = files['script.js'] || "";

            // Inject styles and scripts
            if(css) html = html.replace('</head>', `<style>${css}</style></head>`);
            if(js) html = html.replace('</body>', `<script>${js}<\/script></body>`);

            dom.preview.srcdoc = html;
        }

        // Init
        renderTabs();
        
        dom.input.addEventListener('keydown', (e) => {
            if(e.key === 'Enter') run();
        });

    </script>
</body>
</html>
